This is originally blocks.cpp
